@model Tounaent_Fixtures.Models.PlayerViewModel

@{
    ViewData["Title"] = "Player Registration";
    ViewData["HideNavigation"] = true;
}

<div class="d-flex justify-content-between align-items-center mb-3">
    @if (ViewData["Logo1"] != null)
    {
        <img src="@ViewData["Logo1"]" alt="Logo1" style="height: 80px;" />
    }
    <div class="text-center flex-grow-1">
        <h2>@ViewData["TournamentName"]</h2>
        <h4>@ViewData["Organization"]</h4>
        <h5>@ViewData["Venue"]</h5>
        <h6>@ViewData["Date"]</h6>
    </div>
    @if (ViewData["Logo2"] != null)
    {
        <img src="@ViewData["Logo2"]" alt="Logo2" style="height: 80px;" />
    }
</div>

@if (TempData["Success"] != null)
{
    <script>
        $(document).ready(function () {
            const toast = $('<div class="toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-4" role="alert" aria-live="assertive" aria-atomic="true">' +
                '<div class="d-flex"><div class="toast-body">' +
                '@TempData["Success"]' +
                '</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>');

            $('body').append(toast);
            toast.toast({ delay: 4000 });
            toast.toast('show');
        });
    </script>
}


<form asp-action="Register" method="post" class="container" enctype="multipart/form-data">
    <div class="row g-3">
        <input type="hidden" asp-for="TournamentId" />

        <div class="col-md-6">
            <div class="form-group mb-3">
                <label asp-for="Name" class="form-label"></label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label asp-for="FatherName" class="form-label"></label>
                <input asp-for="FatherName" class="form-control" />
            </div>
        </div>

        <!-- Right Column: Photo Upload + Preview -->
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label asp-for="PhotoFile" class="form-label">Upload Photo</label>
                <input asp-for="PhotoFile" type="file" class="form-control" accept="image/*" onchange="previewPhoto(this)" />
                <span asp-validation-for="PhotoFile" class="text-danger"></span>
            </div>

            <div class="text-center mt-2">
                <label class="form-label">Photo Preview</label><br />
                <img id="photoPreview" src="~/images/placeholder.png" alt="Preview"
                     style="max-width: 200px; max-height: 200px; border: 1px solid #ccc; padding: 5px;" />
            </div>
        </div>

        <!-- Gender -->
        <div class="col-md-6">
            <label class="form-label">Gender</label>
            @foreach (var gender in Model.GenderOptions.Where(g => g.Value == "1" || g.Value == "2"))
            {
                <div class="form-check form-check-inline">
                    <input class="form-check-input gender-radio" type="radio" asp-for="GenderId" value="@gender.Value" id="gender_@gender.Value" />
                    <label class="form-check-label" for="gender_@gender.Value">@gender.Text</label>
                </div>
            }
            <span asp-validation-for="GenderId" class="text-danger"></span>
        </div>

        <!-- DOB -->
        <div class="col-md-6">
            <label class="form-label">Date of Birth</label>
            <input id="dob" name="Dob" class="form-control" type="date" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
        </div>

        <!-- Category -->
        <div class="col-md-6">
            <label class="form-label">Category</label>
            <input type="text" id="categoryName" class="form-control" readonly />
            <input type="hidden" id="CatId" name="CatId" />
        </div>

        <!-- Weight Category -->
        <div class="col-md-6">
            <label asp-for="WeightCatId" class="form-label">Weight Category</label>
            <select asp-for="WeightCatId" class="form-control" id="weightCatDropdown">
                <option value="">-- Select Weight Category --</option>
            </select>
            <span asp-validation-for="WeightCatId" class="text-danger"></span>
        </div>

        <!-- District (readonly) -->
        <div class="col-md-6">
            <label class="form-label">District</label>
            <input type="text" class="form-control" value="@Model.DistrictName" readonly />
            <input type="hidden" id="districtId" value="@Model.DistictId" />
        </div>

        <!-- Club Dropdown -->
        <div class="col-md-6">
            <label asp-for="ClubId" class="form-label">Club Name</label>
            <select asp-for="ClubId" class="form-control" id="clubDropdown">
                <option value="">-- Select Club --</option>
                @foreach (var club in Model.ClubOptions)
                {
                    <option value="@club.Value">@club.Text</option>
                }
            </select>
            <span asp-validation-for="ClubId" class="text-danger"></span>
        </div>


        <div class="col-md-6">
            <label asp-for="Address" class="form-label"></label>
            <textarea asp-for="Address" class="form-control"></textarea>
        </div>
        <div class="col-md-6">
            <label asp-for="MobileNo" class="form-label"></label>
            <input asp-for="MobileNo" class="form-control" />
        </div>

        <div class="col-md-6">
            <label asp-for="Email" class="form-label"></label>
            <input asp-for="Email" class="form-control" />
        </div>


        <div class="col-md-12 text-center">
            <button type="submit" class="btn btn-primary mt-3 px-5">Register</button>
        </div>
    </div>
</form>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
             function previewPhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    $('#photoPreview').attr('src', e.target.result);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function calculateAge(dob) {
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function fetchCategoryAndWeight() {
            const genderId = $("input[name='GenderId']:checked").val();
            const dob = $("#dob").val();
            if (!genderId || !dob) return;

            const age = calculateAge(dob);

            $.ajax({
                url: '/PlayerRegistration/GetCategoryByGenderAndAge',
                type: 'GET',
                data: { genderId, age },
                success: function (data) {
                    if (data && data.categoryName) {
                        $("#categoryName").val(data.categoryName);
                        $("#CatId").val(data.catId);

                        fetchWeightCategories(data.catId);
                    } else {
                        $("#categoryName").val("No category found");
                        $("#CatId").val("");
                        $("#weightCatDropdown").empty().append('<option value="">-- Select Weight Category --</option>');
                    }
                },
                error: function (xhr) {
                    console.error("❌ Category fetch error:", xhr.responseText);
                    alert("❌ Failed to load category.");
                }
            });
        }

        function fetchWeightCategories(catId) {
            if (!catId) return;

            $.ajax({
                url: '/PlayerRegistration/GetWeightCategoriesByCategory',
                type: 'GET',
                data: { catId },
                success: function (weights) {
                    const dropdown = $("#weightCatDropdown");
                    dropdown.empty().append('<option value="">-- Select Weight Category --</option>');
                    $.each(weights, function (i, item) {
                        dropdown.append(`<option value="${item.value}">${item.text}</option>`);
                    });
                },
                error: function (xhr) {
                    console.error("❌ Weight category error:", xhr.responseText);
                    alert("❌ Failed to load weight categories.");
                }
            });
        }

        function fetchClubsByDistrict() {
            const districtId = $("#districtId").val();
            if (!districtId) return;

            $.ajax({
                url: '/PlayerRegistration/GetClubsByDistrict',
                type: 'GET',
                data: { districtId },
                success: function (clubs) {
                    const dropdown = $("#clubDropdown");
                    dropdown.empty().append('<option value="">-- Select Club --</option>');
                    $.each(clubs, function (i, club) {
                        dropdown.append(`<option value="${club.value}">${club.text}</option>`);
                    });
                },
                error: function (xhr) {
                    console.error("❌ Club fetch error:", xhr.responseText);
                    alert("❌ Failed to load clubs.");
                }
            });
        }

        $(document).ready(function () {
            $(".gender-radio").on("change", fetchCategoryAndWeight);
            $("#dob").on("change", fetchCategoryAndWeight);
            fetchClubsByDistrict(); // on page load
        });
    </script>
}
